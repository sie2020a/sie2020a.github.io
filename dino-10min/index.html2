<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Dino 10min â€” skinnable</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{margin:0;padding:0;background:#111;color:#eee;font-family:system-ui,-apple-system,sans-serif}
    header{padding:12px 16px;background:#1a1a1a;border-bottom:1px solid #333;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .left{display:flex;gap:10px;align-items:center}
    .tm{font-size:12px;opacity:.75}
    .hint{padding:8px 16px;font-size:14px;color:#bbb}
    a{color:#7dd3fc}
    button{background:#333;color:#eee;border:1px solid #555;border-radius:8px;padding:6px 10px;cursor:pointer}
    button:hover{background:#3a3a3a}

    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆå†…éƒ¨è§£åƒåº¦ã¯800x450ï¼‰ */
    canvas{
      display:block;
      margin:0 auto;
      background:#222;
      width:min(96vw, 900px);
      height:auto;
      touch-action:none;
      -webkit-user-select:none; user-select:none;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <strong>Dino 10min</strong>
      <span class="tm">Space/ã‚¿ãƒƒãƒ—: ã‚¸ãƒ£ãƒ³ãƒ—ãƒ»é–‹å§‹ / Enter: ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</span>
      <button id="muteBtn" aria-pressed="false">ğŸ”Š Sound ON</button>
    </div>
    <div class="tm">â€œChromeâ„¢ browser ã¯ Google LLC ã®ç™»éŒ²å•†æ¨™ã§ã™â€</div>
  </header>
  <div class="hint">assets/ ã«ç”»åƒãƒ»éŸ³ã‚’ç½®ã‘ã°è‡ªå‹•ã§åæ˜ ã€‚ç„¡ã„å ´åˆã¯å››è§’ï¼†ç„¡éŸ³ã§å‹•ãã¾ã™ã€‚</div>

  <canvas id="canvas" width="800" height="450"></canvas>

  <script>
    // ========= è¨­å®šï¼šèª­ã¿è¾¼ã‚€è³‡ç”£ï¼ˆä»»æ„ï¼‰ =========
    const IMG_PATHS = {
      dino:     "assets/dino.png",
      cactus:   "assets/cactus.png",
      bird:     "assets/bird.png",
      bgFar:    "assets/bg_far.png",
      bgNear:   "assets/bg_near.png",
      ground:   "assets/ground.png",
    };
    const SND_PATHS = {
      bgm:      "assets/bgm.mp3",
      jump:     "assets/jump.mp3",
      gameover: "assets/gameover.mp3",
    };

    // ========= åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— =========
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const game = {
      counter: 0,
      score: 0,
      isGameOver: true,
      timer: null,
      enemys: [],
      enemyCooldown: 0,
      speedBase: 7,
      startedOnce: false, // åˆå›ã‚¿ãƒƒãƒ—æ¤œçŸ¥ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã®éŸ³å†ç”Ÿè§£ç¦ï¼‰
    };

    // è³‡ç”£èª­ã¿è¾¼ã¿ï¼ˆã‚ã£ã¦ã‚‚ãªãã¦ã‚‚OKï¼‰
    const images = {};
    const sounds = {};
    function loadImage(key, src){
      return new Promise((resolve)=> {
        const img = new Image();
        img.onload = ()=>resolve({key, img});
        img.onerror = ()=>resolve({key, img:null});
        img.src = src;
      });
    }
    function loadAudio(key, src){
      return new Promise((resolve)=>{
        const a = new Audio();
        a.preload = "auto";
        a.loop = (key === "bgm");
        a.oncanplaythrough = ()=>resolve({key, audio:a});
        a.onerror = ()=>resolve({key, audio:null});
        a.src = src;
      });
    }
    async function preload(){
      const imgKeys = Object.entries(IMG_PATHS).map(([k,src])=>loadImage(k, src));
      const sndKeys = Object.entries(SND_PATHS).map(([k,src])=>loadAudio(k, src));
      const results = await Promise.all([...imgKeys, ...sndKeys]);
      for(const r of results){
        if ('img' in r) images[r.key] = r.img; else sounds[r.key] = r.audio;
      }
    }

    // ========= åˆæœŸåŒ– =========
    function init() {
      game.counter = 0;
      game.score = 0;
      game.isGameOver = false;
      game.enemys = [];
      game.enemyCooldown = 18;
      game.speedBase = 7;

      createDino();
      clearInterval(game.timer);
      game.timer = setInterval(ticker, 30);
      drawBanner("Ready? ã‚¿ãƒƒãƒ— or Space ã§é–‹å§‹");

      // åˆå›é–‹å§‹å¾Œã«BGMï¼ˆãƒ¢ãƒã‚¤ãƒ«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã—ã‹é³´ã‚‰ãªã„ï¼‰
      if (game.startedOnce && sounds.bgm && !isMuted) {
        try { sounds.bgm.currentTime = 0; sounds.bgm.play(); } catch {}
      }
    }

    // ========= ä¸»å½¹ï¼ˆæç«œï¼‰ =========
    function createDino() {
      // ç”»åƒã®å®Ÿå¯¸ã‚’ä½¿ã„ãŸã„å ´åˆã¯ onload å¾Œã® width/height ã‚’ä½¿ã†ã€‚
      const w = images.dino ? Math.min(images.dino.width, 64) : 48;
      const h = images.dino ? Math.min(images.dino.height, 64) : 48;
      game.dino = {
        x: 110,
        y: canvas.height - h/2,   // åœ°é¢ä¸Šï¼ˆä¸­å¿ƒyï¼‰
        moveY: 0,
        width: w,
        height: h,
        color: "#34d399"
      };
    }

    // ========= ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— =========
    // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ç”¨ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    let bgFarX=0, bgNearX=0, groundX=0;
    function ticker() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      drawBackground();    // èƒŒæ™¯ï¼ˆé æ™¯â†’è¿‘æ™¯ï¼‰
      drawGround();        // åœ°é¢

      // æ•µç”Ÿæˆ
      if (game.enemyCooldown <= 0 && Math.random() < 0.15) {
        spawnEnemy();
        game.enemyCooldown = Math.max(8, 28 - Math.floor(game.score / 150));
      } else {
        game.enemyCooldown--;
      }

      // é€Ÿåº¦ã‚¹ã‚±ãƒ¼ãƒ«
      const spdScale = 1 + Math.min(1.5, game.score / 2000);
      const groundSpeed = game.speedBase * spdScale;

      // ç§»å‹•
      moveDino();
      moveEnemys(groundSpeed);

      // æç”»
      drawDino();
      drawEnemys();

      // å½“ãŸã‚Šåˆ¤å®š
      if (hitCheck()) { gameOver(); return; }

      // ã‚¹ã‚³ã‚¢æ›´æ–°
      game.score += 1;
      drawScore();

      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ›´æ–°
      bgFarX   = (bgFarX   - 0.5*spdScale + 1600) % 1600;
      bgNearX  = (bgNearX  - 1.5*spdScale + 1600) % 1600;
      groundX  = (groundX  - 6*spdScale   + 1600) % 1600;

      // ã‚«ã‚¦ãƒ³ã‚¿
      game.counter = (game.counter + 1) % 1000000;
    }

    // ========= èƒŒæ™¯ãƒ»åœ°é¢ =========
    function drawBackground(){
      // é æ™¯
      if (images.bgFar){
        tileX(images.bgFar, bgFarX, 0);
      } else {
        // ä»£æ›¿: ã‚°ãƒ©ãƒ‡
        const g = ctx.createLinearGradient(0,0,0,canvas.height);
        g.addColorStop(0, "#0c1320");
        g.addColorStop(1, "#111");
        ctx.fillStyle = g;
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }
      // è¿‘æ™¯
      if (images.bgNear){
        tileX(images.bgNear, bgNearX, 0);
      }
    }
    function drawGround() {
      if (images.ground){
        tileX(images.ground, groundX, canvas.height - images.ground.height);
      } else {
        // ä»£æ›¿: é•·æ–¹å½¢ï¼‹ãƒ©ã‚¤ãƒ³
        ctx.fillStyle = "#333";
        ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
        ctx.strokeStyle = "#2a2a2a";
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let x = - (groundX % 40); x < canvas.width; x += 40) {
          ctx.moveTo(x, canvas.height - 30);
          ctx.lineTo(x + 20, canvas.height - 30);
        }
        ctx.stroke();
      }
    }
    // æ¨ªæ–¹å‘ã«ç”»åƒã‚’æ•·ãè©°ã‚ã‚‹
    function tileX(img, offsetX, y){
      const iw = img.width;
      if (!iw) return;
      let x = -offsetX;
      while (x < canvas.width) {
        ctx.drawImage(img, x, y, iw, img.height);
        x += iw;
      }
    }

    // ========= Dino ç§»å‹•/æç”» =========
    function moveDino() {
      const d = game.dino;
      d.y += d.moveY;
      const floorY = canvas.height - d.height / 2;

      if (d.y >= floorY) {
        d.y = floorY;
        d.moveY = 0;
      } else {
        d.moveY += 3; // é‡åŠ›
      }
    }

    function drawDino() {
      const d = game.dino;
      if (images.dino){
        ctx.drawImage(images.dino, d.x - d.width/2, d.y - d.height/2, d.width, d.height);
      } else {
        ctx.fillStyle = d.color;
        ctx.fillRect(d.x - d.width/2, d.y - d.height/2, d.width, d.height);
        ctx.fillStyle = "#000"; // ç›®
        ctx.fillRect(d.x + 10, d.y - 10, 6, 6);
      }
    }

    // ========= æ•µ =========
    function spawnEnemy() {
      const isBird = Math.random() < 0.35;
      if (isBird) {
        const h = images.bird ? Math.min( images.bird.height, 36 ) : 28;
        const w = images.bird ? Math.min( images.bird.width,  48 ) : 40;
        const y = Math.random() * 120 + 170;
        game.enemys.push({
          type: "bird",
          x: canvas.width + w/2,
          y,
          width: w,
          height: h,
          moveX: - (10 + Math.random()*4),
          color: "#60a5fa"
        });
      } else {
        const w = images.cactus ? Math.min(images.cactus.width,  60) : (30 + Math.floor(Math.random()*20));
        const h = images.cactus ? Math.min(images.cactus.height, 80) : (50 + Math.floor(Math.random()*30));
        game.enemys.push({
          type: "cactus",
          x: canvas.width + w/2,
          y: canvas.height - h/2,
          width: w,
          height: h,
          moveX: - (8 + Math.random()*3),
          color: "#f59e0b"
        });
      }
    }

    function moveEnemys(groundSpeed) {
      for (const e of game.enemys) {
        e.x += e.moveX * (groundSpeed / 7);
      }
      game.enemys = game.enemys.filter(e => e.x > -e.width);
    }

    function drawEnemys() {
      for (const e of game.enemys) {
        if (e.type === "bird" && images.bird){
          ctx.drawImage(images.bird, e.x - e.width/2, e.y - e.height/2, e.width, e.height);
        } else if (e.type === "cactus" && images.cactus){
          ctx.drawImage(images.cactus, e.x - e.width/2, e.y - e.height/2, e.width, e.height);
        } else {
          ctx.fillStyle = e.color;
          ctx.fillRect(e.x - e.width/2, e.y - e.height/2, e.width, e.height);
        }
      }
    }

    // ========= å½“ãŸã‚Šåˆ¤å®š =========
    function hitCheck() {
      const d = game.dino;
      for (const e of game.enemys) {
        const hitX = Math.abs(d.x - e.x) < (d.width*0.8/2 + e.width*0.9/2);
        const hitY = Math.abs(d.y - e.y) < (d.height*0.6/2 + e.height*0.9/2);
        if (hitX && hitY) return true;
      }
      return false;
    }

    // ========= ã‚¹ã‚³ã‚¢/ãƒãƒŠãƒ¼/çµ‚äº† =========
    function drawScore() {
      ctx.fillStyle = "#eee";
      ctx.font = "24px system-ui,sans-serif";
      ctx.fillText(`score: ${game.score}`, 12, 30);
    }

    function drawBanner(text) {
      ctx.fillStyle = "rgba(0,0,0,.5)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.font = "bold 48px system-ui,sans-serif";
      ctx.fillText(text, 120, 200);
    }

    function gameOver() {
      game.isGameOver = true;
      clearInterval(game.timer);
      ctx.fillStyle = "#ef4444";
      ctx.font = "bold 64px system-ui,sans-serif";
      ctx.fillText("Game Over!", 210, 200);
      ctx.fillStyle = "#ddd";
      ctx.font = "24px system-ui,sans-serif";
      ctx.fillText("Enterã§ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ / ã‚¿ãƒƒãƒ— or Spaceã§ã‚¸ãƒ£ãƒ³ãƒ—", 110, 240);
      // åŠ¹æœéŸ³
      if (sounds.gameover && !isMuted){
        try { sounds.gameover.currentTime = 0; sounds.gameover.play(); } catch {}
      }
      // BGMåœæ­¢
      if (sounds.bgm) { try { sounds.bgm.pause(); } catch {} }
    }

    // ========= å…¥åŠ›ï¼ˆPC & ã‚¹ãƒãƒ›ï¼šç”»é¢ã©ã“ã§ã‚‚OKï¼‰ =========
    function jump() {
      if (!game.isGameOver && game.dino.moveY === 0) {
        game.dino.moveY = -41;
        if (sounds.jump && !isMuted){
          try { sounds.jump.currentTime = 0; sounds.jump.play(); } catch {}
        }
      }
    }
    function activate(e){
      if (e) e.preventDefault();
      if (!game.startedOnce){
        game.startedOnce = true;
        // ãƒ¢ãƒã‚¤ãƒ«ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè§£ç¦ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç›´å¾Œã«playã‚’è©¦ã™
        if (sounds.bgm && !isMuted){
          try { sounds.bgm.currentTime = 0; sounds.bgm.play(); } catch {}
        }
      }
      if (game.isGameOver) { init(); setTimeout(()=>jump(),60); }
      else { jump(); }
    }

    document.addEventListener('keydown', (e) => {
      if (e.code === "Space") activate(e);
      if (e.code === "Enter" && game.isGameOver) init();
    });
    ['pointerdown','touchstart','mousedown','click'].forEach(ev=>{
      window.addEventListener(ev, (e)=>activate(e), { passive:false });
    });

    // ========= ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿ =========
    let isMuted = false;
    const muteBtn = document.getElementById('muteBtn');
    function updateMuteUI(){
      muteBtn.textContent = isMuted ? "ğŸ”‡ Sound OFF" : "ğŸ”Š Sound ON";
      muteBtn.setAttribute('aria-pressed', String(!isMuted));
      // å†ç”Ÿä¸­ã®BGMã‚’åŒæœŸ
      if (sounds.bgm){
        if (isMuted) { try { sounds.bgm.pause(); } catch {} }
        else if (!game.isGameOver && game.startedOnce) { try { sounds.bgm.play(); } catch {} }
      }
    }
    muteBtn.addEventListener('click', ()=>{
      isMuted = !isMuted;
      updateMuteUI();
    });

    // ========= åˆæœŸè¡¨ç¤º =========
    (async () => {
      await preload();          // ç”»åƒãƒ»éŸ³ãŒã‚ã‚Œã°å–å¾—
      updateMuteUI();           // ãƒœã‚¿ãƒ³è¡¨ç¤ºåŒæœŸ
      ctx.fillStyle = "#eee";
      ctx.font = "bold 36px system-ui,sans-serif";
      ctx.fillText("Dino 10min â€” Skinnable", 180, 160);
      ctx.font = "24px system-ui,sans-serif";
      ctx.fillText("ã‚¿ãƒƒãƒ—/Spaceã§é–‹å§‹ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ / Enterã§ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ", 110, 210);
      if (images.bgFar || images.bgNear || images.ground){
        ctx.font = "16px system-ui,sans-serif";
        ctx.fillText("â€» assets/ ã®ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ", 250, 250);
      }
    })();
  </script>
</body>
</html>
